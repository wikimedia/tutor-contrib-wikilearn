name: Deploy to EKS Dev (Self-Hosted)

on:
  push:
    branches:
      - master
      - dev
  workflow_dispatch:

env:
  WIKILEARN_BRANCH: master
  INDIGO_WIKILEARN_BRANCH: develop
  LMS_HOST: learnwiki-dev.edly.io
  VENV: /home/ubuntu/venv
  TUTOR: /home/ubuntu/venv/bin/tutor
  PIP: /home/ubuntu/venv/bin/pip

jobs:
  deploy:
    runs-on: [self-hosted, WM-EKS-runner, wikilearn]
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        run: |
          python3 --version
          pip3 --version

      - name: Setup or update virtualenv
        run: |
          if [ ! -d "$VENV" ]; then
            echo "Creating new virtualenv"
            python3 -m venv $VENV
          else
            echo "Using existing virtualenv"
          fi
          $PIP install --upgrade pip setuptools wheel

      - name: Install Tutor and plugins from source
        run: |
          $PIP install --upgrade --editable \
            "git+https://github.com/wikimedia/tutor-contrib-wikilearn.git@${WIKILEARN_BRANCH}#egg=tutor-contrib-wikilearn"
          $PIP install --upgrade --editable \
            "git+https://github.com/wikimedia/tutor-indigo-wikilearn.git@${INDIGO_WIKILEARN_BRANCH}#egg=tutor-indigo-wikilearn"

      - name: Verify Tutor installation
        run: |
          $TUTOR --version
          $TUTOR plugins list

      - name: Stop Tutor services
        run: |
          if [ -d ~/.local/share/tutor/env ]; then
            echo "Stopping Tutor containers..."
            $TUTOR local stop || echo "Failed to stop some containers, continuing..."
          else
            echo "No Tutor environment found"
          fi

      - name: Enable Wikilearn plugins
        run: |
          $TUTOR plugins enable wikilearn
          $TUTOR wikilearn enable
          $TUTOR plugins list

      - name: Display configuration
        run: |
          echo "=== Tutor Configuration ==="
          $TUTOR config printroot
          $TUTOR config printvalue LMS_HOST
          $TUTOR config printvalue CMS_HOST

      - name: Build Docker images
        run: |
          echo "Building Docker images..."
          $TUTOR images build all --no-cache
        # timeout-minutes: 45

      - name: Launch Tutor platform
        run: |
          echo "Launching Tutor platform..."
          $TUTOR local launch --skip-build --non-interactive

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30
          
          # Check if containers are running
          docker ps --filter "name=tutor" --format "table {{.Names}}\t{{.Status}}"

      - name: Deployment summary
        if: always()
        run: |
          echo "==================================="
          echo "Deployment Summary"
          echo "==================================="
          echo "Branch: $WIKILEARN_BRANCH"
          echo "LMS URL: https://$LMS_HOST"
          echo "CMS URL: https://studio.$LMS_HOST"
          # echo "Admin credentials: admin/admin"
          # echo "Student credentials: student/student"
          echo "==================================="
          echo "Tutor status:"
          $TUTOR local status
